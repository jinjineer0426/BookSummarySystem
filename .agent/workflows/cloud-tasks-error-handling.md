---
description: Cloud Tasks ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ç„¡é™ãƒªãƒˆãƒ©ã‚¤é˜²æ­¢ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
---

# Cloud Tasks ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

## èƒŒæ™¯ (2025-12-23 ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆ)

ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ€ãƒŸãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ID (`test_123`) ã‚’å«ã‚€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒ Cloud Tasks ã«ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°ã•ã‚Œã€**58å›žã‚‚ç„¡é™ãƒªãƒˆãƒ©ã‚¤**ã•ã‚ŒãŸã€‚åŽŸå› ã¯ã€Cloud Function ãŒ `500 Internal Server Error` ã‚’è¿”ã—ã¦ã„ãŸãŸã‚ã€Cloud Tasks ãŒã€Œä¸€æ™‚çš„ãªéšœå®³ã€ã¨åˆ¤æ–­ã—ã¦ãƒªãƒˆãƒ©ã‚¤ã—ç¶šã‘ãŸã“ã¨ã€‚

## é‡è¦ãªåŽŸå‰‡

### 1. Cloud Tasks ã®ãƒªãƒˆãƒ©ã‚¤åˆ¤å®šãƒ«ãƒ¼ãƒ«

| HTTP Status | Cloud Tasks ã®å‹•ä½œ |
|-------------|-------------------|
| `2xx` (200-299) | âœ… æˆåŠŸã€‚ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã€‚ |
| `4xx` (400-499) | âš ï¸ **ãƒªãƒˆãƒ©ã‚¤ã—ãªã„**ã€‚æ°¸ç¶šçš„ãªå¤±æ•—ã¨ã—ã¦æ‰±ã†ã€‚ |
| `5xx` (500-599) | ðŸ”„ **ãƒªãƒˆãƒ©ã‚¤ã™ã‚‹**ã€‚ä¸€æ™‚çš„ãªéšœå®³ã¨ã—ã¦æ‰±ã†ã€‚ |

### 2. ã€Œå›žå¾©ä¸èƒ½ãªã‚¨ãƒ©ãƒ¼ã€ã¯ 200 OK ã§è¿”ã™

Cloud Tasks ãƒãƒ³ãƒ‰ãƒ©å†…ã§ç™ºç”Ÿã—ãŸ**æ°¸ç¶šçš„ã«å›žå¾©ã—ãªã„ã‚¨ãƒ©ãƒ¼**ã¯ã€ãƒ­ã‚°ã«è¨˜éŒ²ã—ãŸå¾Œ `200 OK` ã‚’è¿”ã™ã¹ãã€‚ã“ã‚Œã«ã‚ˆã‚Š Cloud Tasks ãŒãƒªãƒˆãƒ©ã‚¤ã‚’åœæ­¢ã™ã‚‹ã€‚

**å›žå¾©ä¸èƒ½ãªã‚¨ãƒ©ãƒ¼ã®ä¾‹:**
- ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„ (404)
- å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ (ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼)
- æ¨©é™ãŒãªã„ (403)
- ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒå¯¾å¿œå¤–

```python
# è‰¯ã„ä¾‹: å›žå¾©ä¸èƒ½ãªã‚¨ãƒ©ãƒ¼ã‚’200ã§è¿”ã™
try:
    file_metadata = drive_service.files().get(fileId=file_id).execute()
except HttpError as e:
    if e.resp.status == 404:
        logger.error(f"File not found: {file_id}")
        tracker.mark_failed("File not found", "file_not_found")
        # 200 ã§è¿”ã™ã“ã¨ã§ãƒªãƒˆãƒ©ã‚¤ã‚’åœæ­¢
        return json.dumps({'error': 'File not found'}), 200
    raise  # ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ã¯500ã¨ã—ã¦å†ã‚¹ãƒ­ãƒ¼ (ãƒªãƒˆãƒ©ã‚¤ã•ã›ã‚‹)
```

### 3. å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€Œã‚­ãƒ¥ãƒ¼ã«å…¥ã‚Œã‚‹å‰ã€ã«è¡Œã†

Cloud Function ã®ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ (`process_book`) ã§ä¸æ­£ãªå…¥åŠ›ã‚’å¼¾ãã“ã¨ã§ã€ãã‚‚ãã‚‚ã‚¿ã‚¹ã‚¯ãŒã‚­ãƒ¥ãƒ¼ã«å…¥ã‚‹ã“ã¨ã‚’é˜²ãã€‚

```python
def _is_valid_drive_file_id(file_id: str) -> bool:
    if not file_id or len(file_id) < 20:
        return False
    if file_id.startswith("test_"):
        return False
    return bool(re.match(r'^[a-zA-Z0-9_-]+$', file_id))
```

## ã‚¹ã‚¿ãƒƒã‚¯ã—ãŸã‚¿ã‚¹ã‚¯ã®èª¿æŸ»ãƒ»å‰Šé™¤æ‰‹é †

### 1. ã‚­ãƒ¥ãƒ¼ã®çŠ¶æ…‹ã‚’ç¢ºèª
```bash
gcloud tasks list \
  --queue=book-summary-queue \
  --location=asia-northeast1 \
  --project=gen-lang-client-0341760389 \
  --format="json"
```

### 2. å•é¡Œã®ã‚¿ã‚¹ã‚¯ã®è©³ç´°ã‚’ç¢ºèª (ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰å«ã‚€)
```bash
gcloud tasks describe TASK_NAME --response-view=FULL --format="json"
# ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¯ base64 ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã®ã§ãƒ‡ã‚³ãƒ¼ãƒ‰
echo "BASE64_BODY" | base64 -d
```

### 3. ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤
```bash
gcloud tasks delete TASK_NAME --quiet
```

## ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ: æ–°ã—ã„ Cloud Tasks ãƒãƒ³ãƒ‰ãƒ©ã‚’ä½œæˆã™ã‚‹éš›

- [ ] å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã§å®Ÿæ–½ã—ã¦ã„ã‚‹ã‹
- [ ] å›žå¾©ä¸èƒ½ãªã‚¨ãƒ©ãƒ¼ã‚’ `200 OK` ã§è¿”ã—ã¦ã„ã‚‹ã‹
- [ ] `JobTracker` ã§ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã‚’è¨˜éŒ²ã—ã¦ã„ã‚‹ã‹
- [ ] æ§‹é€ åŒ–ãƒ­ã‚°ã§ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’å‡ºåŠ›ã—ã¦ã„ã‚‹ã‹
- [ ] ãƒ†ã‚¹ãƒˆæ™‚ã« `test_` ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦ã„ãªã„ã‹ï¼ˆåˆã¯ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§å¼¾ã„ã¦ã„ã‚‹ã‹ï¼‰

## é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- `cloud_function/main.py`: `_is_valid_drive_file_id()`, `prepare_book()`
- `cloud_function/services/job_tracker.py`: `mark_failed()`
